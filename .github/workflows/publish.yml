# This github action builds Alibi Detect and publishes it to PyPI.
# It is only run when a new tag is pushed to github.
# See https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/
name: Publish Alibi Detect ðŸ“¦ to PyPI 

on: push

jobs:
  build-n-publish:
    name: Build and publish Alibi Detect
    runs-on: ubuntu-18.04

    steps:
    # Setup
    - uses: actions/checkout@master
    - name: Set up Python 3.9
      uses: actions/setup-python@v1
      with:
        python-version: 3.9

    # Build
    - name: Install pypa/build
      run: python -m pip install --user build==0.9.0
    - name: Build a binary wheel and a source tarball
      run: python -m build --sdist --wheel --outdir dist/ .

    # Publish to test PyPI TODO - perhaps only do this for rc tags?
    - name: Publish distribution ðŸ“¦ to Test PyPI
      if: startsWith(github.ref, 'refs/tags')  # Only publish when tag pushed
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/
          
#    # Publish to real PyPI TODO - only do this for non-rc tags?
#    - name: Publish distribution ðŸ“¦ to PyPI
#      if: startsWith(github.ref, 'refs/tags')
#      uses: pypa/gh-action-pypi-publish@release/v1
#      with:
#        password: ${{ secrets.PYPI_API_TOKEN }}        
